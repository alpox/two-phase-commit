<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi"
  />
  <title>Transaction consistency in a distributed database environment</title>
  <script src="./js/app.js"></script>
  <script src="./js/vendor.js"></script>
  <script>require('js/initialize');</script>
  <link rel="stylesheet" href="./css/app.css" type="stylesheet">
  <link rel="stylesheet" href="./css/vendor.css" type="stylesheet">
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="column">
        <div class="slim">
          <h4>Transaction consistency in a distributed database environment</h4>
          <p>by <a href="https://github.com/rafaelkallis" target="_blank">Rafael Kallis</a>, <a href="https://github.com/alpox"
              target="_blank">Elias Bernhaut</a></p>
          <h5>Table of Properties</h5>
          <ul>
            <li><a href="#problem">Problem Definition</a></li>
            <li><a href="#2pc">Two Phase Commit</a></li>
            <li><a href="#simulation">Simulation</a></li>
            <li><a href="#formalisation">Formalisation of the problem</a></li>
          </ul>
          <h5 id="problem">Problem Definition</h5>
          <p>Unlike a transaction on a local database, a distributed transaction involves altering data on multiple databases.
            Consequently, distributed transaction processing is more complicated, because the database must coordinate the
            committing or aborting the changes in a transaction as a self-contained unit. In other words, the entire transaction
            commits, or the entire transaction aborts.</p>
          <h5 id="2pc">Two Phase Commit Protocol</h5>
          <p>The database ensures the integrity of data in a distributed transaction using the two-phase commit mechanism. In
            the prepare phase, the coordinator in the transaction asks the subordinates to promise to commit or abort the
            transaction. If all subordinates are able to commit the transaction, the transaction stages in the commit phase,
            otherwise it stages in the abort phase. During the commit phase, the coordinator asks all subordinates to commit
            the transaction. During the abort phase, all subordinates are asked to abort. You can view an illustration of
            the protocol below.</p>
        </div>
        <div class="extra-slim" style="text-align: center;">
          <div class="box">
            <img src="./img/protocol.svg">
          </div>
          <div class="plot-description">Figure 1: Two phase commit protocol diagram, note that an * next to the record type means that the record is forced
            to stable storage.</div>
        </div>
        <div class="slim">
          <p>We assume that each tranaction runs through a different instance of the state charts below. When the transaction
            starts, the coordinator sends prepare messages to all subordinates. The coordinator awaits all subordinates to
            respond with their votes. If all subordinates responded with a yes vote the coordinator sends commit messages
            to all subordinates. If any subordinate responded to the prepare message with a no or a timeout has occured,
            the coordinator sends abort messages to all subordinates. After sending commit (abort) messages, the coordinator
            awaits all subordinates to respond with an ack message. If a timeout occurres while waiting, the coordinator
            retransmitts the commit (abort) message to the respective subordinate. The transaction ends when all subordinates
            have responded with an ack message to the coordinator's commit (abort) message.</p>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <div class="box">
          <img src="./img/coordinator.svg">
        </div>
        <div class="plot-description">Figure 2: Coordinator state chart</div>
      </div>
      <div class="column">
        <div class="box">
          <img src="./img/subordinate.svg">
        </div>
        <div class="plot-description">Figure 3: Subordinate state chart</div>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <div class="slim">
          <h5 id="simulation">Simulation</h5>
          <p>
            Below you can have some hands-on experience on the two phase commit protocol. The simulation shows you that it is impossible
            not to reach a consistent state. You can start a transaction by pressing <code>enter</code> or <code>return</code>            depending on your machine. On the top left, you can see what's going on with the coordinator. On the top right,
            you have an overview of the statuses from your transactions. On the middle row you have an overview of your 3
            subordinates. It is also possible to inject some bugs. You can do so by selecting the appropriate bug from the
            panel below the subordinates. Note that if selecting a bug that is injected on a subordinate, there's a slight
            chance that the bug won't be injected succesfully, since the bugs are injected uniformly among the subordinates.
            You can also crash a node by clicking on the coordinator's or the subordinates' label.
          </p>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <div class="box">
          <div id="coordinator-explosion"></div>
          <a id="coordinator-active-button" class="button">Coordinator</a>
          <div id="coordinator-log" class="log"></div>
        </div>
      </div>
      <div class="column">
        <div class="box">
          <a class="button button-outline">Transactions</a>
          <div id="transaction-log" class="log"></div>
        </div>
      </div>
    </div>
    <div class="row">
      <div id="subordinate1" class="column">
        <div class="box">
          <div id="subordinate1-explosion"></div>
          <a id="subordinate1-active-button" class="button">Subordinate 1</a>
          <div id="subordinate1-log" class="log"></div>
        </div>
      </div>
      <div id="subordinate2" class="column">
        <div class="box">
          <div id="subordinate2-explosion"></div>
          <a id="subordinate2-active-button" class="button">Subordinate 2</a>
          <div id="subordinate2-log" class="log"></div>
        </div>
      </div>
      <div id="subordinate3" class="column">
        <div class="box">
          <div id="subordinate3-explosion"></div>
          <a id="subordinate3-active-button" class="button">Subordinate 3</a>
          <div id="subordinate3-log" class="log"></div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <div class="box">
          <div class="row">
            <div class="column">
              <div>
                <input id="sub-vote-no" type="checkbox">
                <label class="label-inline" for="sub-vote-no">Subordinate no vote</label>
              </div>
              <div>
                <input id="sub-crash-prepare-receiving" type="checkbox">
                <label class="label-inline" for="sub-crash-prepare-receiving">Subordinate crash prepare receiving</label>
              </div>
              <div>
                <input id="sub-crash-prepare-sending" type="checkbox">
                <label class="label-inline" for="sub-crash-prepare-sending">Subordinate crash prepare sending</label>
              </div>
              <div>
                <input id="sub-crash-commit-receiving" type="checkbox">
                <label class="label-inline" for="sub-crash-commit-receiving">Subordinate crash commit receiving</label>
              </div>
              <div>
                <input id="sub-crash-commit-sending" type="checkbox">
                <label class="label-inline" for="sub-crash-commit-sending">Subordinate crash commit sending</label>
              </div>
              <div>
                <input id="sub-crash-abort-receiving" type="checkbox">
                <label class="label-inline" for="sub-crash-abort-receiving">Subordinate crash abort receiving</label>
              </div>
              <div>
                <input id="sub-crash-abort-sending" type="checkbox">
                <label class="label-inline" for="sub-crash-abort-sending">Subordinate crash abort sending</label>
              </div>
              <div>
                <label id="duration-value" for="duration-input">Delay: 1500</label>
                <input id="duration-input" type="range" min="500" max="3000" value="1500" step="500">
              </div>
            </div>
            <div class="column">
              <div>
                <input id="coord-crash-prepare-receiving" type="checkbox">
                <label class="label-inline" for="coord-crash-prepare-receiving">Coordinator crash prepare receiving</label>
              </div>
              <div>
                <input id="coord-crash-prepare-sending" type="checkbox">
                <label class="label-inline" for="coord-crash-prepare-sending">Coordinator crash prepare sending</label>
              </div>
              <div>
                <input id="coord-crash-commit-receiving" type="checkbox">
                <label class="label-inline" for="coord-crash-commit-receiving">Coordinator crash commit receiving</label>
              </div>
              <div>
                <input id="coord-crash-commit-sending" type="checkbox">
                <label class="label-inline" for="coord-crash-commit-sending">Coordinator crash commit sending</label>
              </div>
              <div>
                <input id="coord-crash-abort-receiving" type="checkbox">
                <label class="label-inline" for="coord-crash-abort-receiving">Coordinator crash abort receiving</label>
              </div>
              <div>
                <input id="coord-crash-abort-sending" type="checkbox">
                <label class="label-inline" for="coord-crash-abort-sending">Coordinator crash abort sending</label>
              </div>
              <div>
                <a id="start-transaction-button" class="button">Start</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="column">
        <h5 id="formalisation">Formalisation of the problem</h5>
        <div>
          Let
          <span class="katex">\footnotesize N = \{ 0, 1, ..., n \}</span> denote the set of nodes, which includes the coordinator
          and all subordinates.
        </div>
        <div>
          Let
          <span class="katex">\footnotesize n_0 \in N</span> denote the coordinator.
        </div>
        <div>
          Let
          <span class="katex">\footnotesize n_i\in N, \quad i \ne 0</span> denote any subordinate.
        </div>
        <div>
          Let
          <span class="katex">\footnotesize T = \{ 0, ... , m \}</span> denote the set of transactions.
        </div>
        <div>Let
          <span class="katex">\footnotesize t \in T</span> denote a transaction.
        </div>
        <div>
          Let
          <span class="katex">\footnotesize S = \{ Commit, Abort \}</span> denote the set of possible states. Note that the
          states used here are independent from the states used in the state charts above.
        </div>
        <div>
          Let
          <span class="katex">\footnotesize f : N \times T \rightarrow S</span> denote the function which maps any node and
          transaction to a state.
        </div>
        <div>
          In order to reach a consistent state, following condition must be satisfied:
          <div style="text-align: center; margin-top: 20px;">
            <span class="katex">\large f(n_i,t) = f(n_j,t), \quad \forall i,j</span>
          </div>
        </div>
        <blockquote>
          <p><strong>(Theorem 1)</strong>
            <span class="katex">\footnotesize f(n_i,t)=Commit \Rightarrow f(n_0,t)=Commit, i\ne 0</span> (If a subordinate
            is in commit state, the coordinator must also be in commit state)
          </p>
          <p><strong>Proof:</strong> In order for subordinate
            <span class="katex">\footnotesize n_i</span> to be in commit state, the coordinator
            <span class="katex">\footnotesize n_0</span> must have entered the commit state before
            <span class="katex">\footnotesize n_i</span> and then sent a commit message to
            <span class="katex">\footnotesize n_i</span>. It is impossible for the coordinator to send a commit message,
            if he is not in the commit state.</p>
        </blockquote>
        <blockquote>
          <p><strong>(Theorem 2)</strong>
            <span class="katex">\footnotesize f(n_i,t)=Abort \Rightarrow f(n_0,t)=Abort, i\ne 0</span> (If a subordinate
            is in abort state, the coordinator must also be in abort state)
          </p>
          <p><strong>Proof:</strong> (Analogus to 1) In order for subordinate
            <span class="katex">\footnotesize n_i</span> to be in abort state, the coordinator
            <span class="katex">\footnotesize n_0</span> must have entered the abort state before
            <span class="katex">\footnotesize n_i</span> and then sent an abort message to
            <span class="katex">\footnotesize n_i</span>. It is impossible for the coordinator to send an abort message,
            if he is not in the abort state.</p>
        </blockquote>
        <blockquote>
          <p><strong>(Theorem 3)</strong>
            <span class="katex">\footnotesize f(n_0,t)=Commit \Rightarrow f(n_i,t)=Commit, i \ne 0</span> (If the coordinator
            is in commit state, all subordinates must also be in commit state)
          </p>
          <p><strong>Proof:</strong> If the coordinator
            <span class="katex">\footnotesize n_0</span> enters commit state, he must send commit messages to all subordinates
            <span class="katex">\footnotesize n_i</span>. All subordinates must respond to the commit message with an ack
            message. If the coordinator doesn't receive an ack message from a subordinate after a fixed timeout, the coordinator
            retransmitts the commit message. It is impossible for the coordinator to send any other message than the commit
            message in the commit phase. Eventually all subordinates will receive the commit message, thus every subordinate
            <span class="katex">\footnotesize n_i</span> must be in commit state.</p>
        </blockquote>
        <blockquote>
          <p><strong>(Theorem 4)</strong>
            <span class="katex">\footnotesize f(n_0,t)=Abort \Rightarrow f(n_i,t)=Abort, i \ne 0</span> (If the coordinator
            is in abort state, all subordinates must also be in abort state)
          </p>
          <p><strong>Proof:</strong> (Analogus to 3) If the coordinator
            <span class="katex">\footnotesize n_0</span> enters abort state, he must send abort messages to all subordinates
            <span class="katex">\footnotesize n_i</span>. All subordinates must respond to the abort message with an ack
            message. If the coordinator doesn't receive an ack message from a subordinate after a fixed timeout, the coordinator
            retransmitts the abort message. It is impossible for the coordinator to send any other message than the abort
            message in the abort phase. Eventually all subordinates will receive the abort message, thus every subordinate
            <span class="katex">\footnotesize n_i</span> must be in abort state.</p>
        </blockquote>
        <blockquote>
          <p><strong>(Theorem 5)</strong>
            <span class="katex">\footnotesize f(n_i,t)=Commit \Leftrightarrow f(n_j,t)=Commit</span> (If one node is in commit
            state, then all other nodes must also be in commit state)
          </p>
          <p><strong>Proof:</strong> We consider 3 possible cases:</p>
          <p><strong>Case 1:</strong>
            <span class="katex">\footnotesize i \ne j = 0</span> (
            <span class="katex">\footnotesize n_i</span> is subordinate,
            <span class="katex">\footnotesize n_j</span> is coordinator)</p>
          <p>As shown in (1), if
            <span class="katex">\scriptsize f(n_i,t)=Commit \Rightarrow f(n_j,t)=Commit</span>, and as shown in (3) if
            <span class="katex">\scriptsize f(n_j,t)=Commit \Rightarrow f(n_i,t)=Commit</span>, thus
            <span class="katex">\scriptsize f(n_i,t)=Commit \Leftrightarrow f(n_j,t)=Commit</span>, for
            <span class="katex">\scriptsize i \ne j = 0</span>.
            <p><strong>Case 2:</strong>
              <span class="katex">\footnotesize j \ne i = 0</span> (
              <span class="katex">\footnotesize n_i</span> is coordinator,
              <span class="katex">\footnotesize n_j</span> is subordinate)</p>
            <p>As shown in (1), if
              <span class="katex">\scriptsize f(n_j, t)=Commit \Rightarrow f(n_i,t)=Commit</span>, and as shown in (3) if
              <span class="katex">\scriptsize f(n_i,t)=Commit \Rightarrow f(n_j, t)=Commit</span>, thus
              <span class="katex">\scriptsize f(n_j,t)=Commit \Leftrightarrow f(n_i,t)=Commit</span>, for
              <span class="katex">\scriptsize j \ne i = 0</span>.</p>
            <p><strong>Case 3:</strong>
              <span class="katex">\footnotesize i \ne j, \quad i,j \ne 0</span> (both
              <span class="katex">\footnotesize n_i,n_j</span> are subordinates)</p>
            <p>As shown in (1), if
              <span class="katex">\scriptsize f(n_i,t)=Commit \Rightarrow f(n_0, t)</span>, and as shown in (3) if
              <span class="katex">\scriptsize f(n_0,t)=Commit \Rightarrow f(n_j,t)</span>. Intuitively this means that WLOG
              if subordinate
              <span class="katex">\scriptsize n_i</span> is in commit state, the coordinator also must be in commit state
              and thus subordinate
              <span class="katex">\scriptsize n_j</span> also must be in commit state. Thus
              <span class="katex">\scriptsize f(n_j,t)=Commit \Leftrightarrow f(n_i,t)=Commit</span>, for
              <span class="katex">\scriptsize i \ne j, \space i,j \ne 0</span>.</p>
            <p>From cases 1,2,3 follows that
              <span class="katex">\footnotesize f(n_i,t)=Commit \Leftrightarrow f(n_j,t)=Commit</span>. Simply put, it means
              that if a node is in commit state, any other node also must be in commit state.</p>
        </blockquote>
        <blockquote>
          <p><strong>(Theorem 6)</strong>
            <span class="katex">\footnotesize f(n_i,t)=Abort \Leftrightarrow f(n_j,t)=Abort</span> (If one node is in abort
            state, then all other nodes must also be in abort state)
          </p>
          <p><strong>Proof:</strong> (Analogus to 5) We consider 3 possible cases:</p>
          <p><strong>Case 1:</strong>
            <span class="katex">\footnotesize i \ne j = 0</span> (
            <span class="katex">\footnotesize n_i</span> is subordinate,
            <span class="katex">\footnotesize n_j</span> is coordinator)</p>
          <p>As shown in (2), if
            <span class="katex">\scriptsize f(n_i,t)=Abort \Rightarrow f(n_j,t)=Abort</span>, and as shown in (4) if
            <span class="katex">\scriptsize f(n_j,t)=Abort \Rightarrow f(n_i,t)=Abort</span>, thus
            <span class="katex">\scriptsize f(n_i,t)=Abort \Leftrightarrow f(n_j,t)=Abort</span>, for
            <span class="katex">\scriptsize i \ne j = 0</span>.
            <p><strong>Case 2:</strong>
              <span class="katex">\footnotesize j \ne i = 0</span> (
              <span class="katex">\footnotesize n_i</span> is coordinator,
              <span class="katex">\footnotesize n_j</span> is subordinate)</p>
            <p>As shown in (2), if
              <span class="katex">\scriptsize f(n_j, t)=Abort \Rightarrow f(n_i,t)=Abort</span>, and as shown in (4) if
              <span class="katex">\scriptsize f(n_i,t)=Abort \Rightarrow f(n_j, t)=Abort</span>, thus
              <span class="katex">\scriptsize f(n_j,t)=Abort \Leftrightarrow f(n_i,t)=Abort</span>, for
              <span class="katex">\scriptsize j \ne i = 0</span>.</p>
            <p><strong>Case 3:</strong>
              <span class="katex">\footnotesize i \ne j, \quad i,j \ne 0</span> (both
              <span class="katex">\footnotesize n_i,n_j</span> are subordinates)</p>
            <p>As shown in (2), if
              <span class="katex">\scriptsize f(n_i,t)=Abort \Rightarrow f(n_0, t)</span>, and as shown in (4) if
              <span class="katex">\scriptsize f(n_0,t)=Abort \Rightarrow f(n_j,t)</span>. Intuitively this means that WLOG
              if subordinate
              <span class="katex">\scriptsize n_i</span> is in abort state, the coordinator also must be in abort state and
              thus subordinate
              <span class="katex">\scriptsize n_j</span> also must be in abort state. Thus
              <span class="katex">\scriptsize f(n_j,t)=Abort \Leftrightarrow f(n_i,t)=Abort</span>, for
              <span class="katex">\scriptsize i \ne j, \space i,j \ne 0</span>.</p>
            <p>From cases 1,2,3 follows that
              <span class="katex">\footnotesize f(n_i,t)=Abort \Leftrightarrow f(n_j,t)=Abort</span>. Simply put, it means
              that if a node is in abort state, any other node also must be in abort state.</p>
        </blockquote>
        <blockquote>
          <p><strong>(Theorem 7)</strong>
            <span class="katex">\footnotesize f(n_i,t)=f(n_j,t)</span> (all nodes have the same state, consistent state)
          </p>
          <p><strong>Proof:</strong> As shown in (5) and (6), if any node is in commit (abort) state, then any other node must
            be in commit (abort) state. Thus</p>
          <div style="text-align: center">
            <span class="katex">\large f(n_i,t)=f(n_j,t),\quad \forall i,j</span>
          </div>
          <div style="text-align: right;">
            <span class="katex">\square</span>
          </div>
        </blockquote>
      </div>
    </div>
  </div>
</body>

</html>